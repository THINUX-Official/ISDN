@model IEnumerable<ISDN_Distribution.Models.AdminOrderViewModel>
@{
    ViewData["Title"] = "RDC Order Hub";

    // ViewModel එකේ properties පාවිච්චි කරලා ලිස්ට් 3 වෙන් කරගනිමු
    var pendingOrders = Model.Where(m => m.IsPendingConfirmation).ToList();
    var packedOrders = Model.Where(m => m.IsPackedAndActive).ToList();
    var returnRequests = Model.Where(m => m.HasPendingReturn).ToList();
}

<div class="container-fluid py-4 bg-light min-vh-100">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold text-dark mb-1"><i class="fas fa-tasks text-primary"></i> RDC Order Management</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">RDC ID: @ViewBag.RdcId</li>
                    <li class="breadcrumb-item active">Operational Dashboard</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row g-3 mb-4 text-center">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-primary text-white p-3 rounded-4">
                <h6 class="text-uppercase small fw-bold">Pending Confirmation</h6>
                <h3 class="mb-0">@pendingOrders.Count</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-dark text-white p-3 rounded-4">
                <h6 class="text-uppercase small fw-bold">Packed & Active</h6>
                <h3 class="mb-0">@packedOrders.Count</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-danger text-white p-3 rounded-4">
                <h6 class="text-uppercase small fw-bold">Return Requests</h6>
                <h3 class="mb-0">@returnRequests.Count</h3>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-white border-0 pt-3">
            <ul class="nav nav-pills nav-fill" id="orderTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active fw-bold" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                        <i class="fas fa-clock me-2"></i>Pending Orders
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" id="packed-tab" data-bs-toggle="tab" data-bs-target="#packed" type="button">
                        <i class="fas fa-box me-2"></i>Packed Orders
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold text-danger" id="returns-tab" data-bs-toggle="tab" data-bs-target="#returns" type="button">
                        <i class="fas fa-undo-alt me-2"></i>Return Requests
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-0">
            <div class="tab-content" id="orderTabsContent">

                <div class="tab-pane fade show active" id="pending" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Order Details</th>
                                    <th>Customer</th>
                                    <th>Value</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in pendingOrders)
                                {
                                    <tr>
                                        <td class="ps-4">
                                            <span class="fw-bold d-block">#@item.Order.OrderNumber</span>
                                            <small class="text-muted">Placed: @item.Order.CreatedAt.ToString("g")</small>
                                        </td>
                                        <td>@item.Order.User?.FullName</td>
                                        <td><span class="badge bg-soft-success text-success fw-bold">LKR @item.Order.TotalAmount.ToString("N2")</span></td>
                                        <td class="text-center">
                                            <form asp-action="MarkAsPacked" method="post">
                                                <input type="hidden" name="orderId" value="@item.Order.OrderId" />
                                                <button type="submit" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">
                                                    <i class="fas fa-check-circle me-1"></i> Confirm & Pack
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="packed" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-muted">
                            <thead class="bg-light text-dark">
                                <tr>
                                    <th class="ps-4">Order Details</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in packedOrders)
                                {
                                    <tr>
                                        <td class="ps-4 fw-medium text-dark">#@item.Order.OrderNumber</td>
                                        <td>@item.Order.User?.FullName</td>
                                        <td><span class="badge bg-info">PACKED</span></td>
                                        <td>
                                            <button class="btn btn-outline-secondary btn-sm rounded-circle"><i class="fas fa-eye"></i></button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="returns" role="tabpanel">
                    <div class="p-4">
                        @foreach (var item in returnRequests)
                        {
                            <div class="card border border-danger border-opacity-25 mb-3 rounded-4 shadow-sm overflow-hidden">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <h6 class="fw-bold mb-0 text-danger">Order #@item.Order.OrderNumber</h6>
                                            <small class="text-muted">Total: LKR @item.Order.TotalAmount.ToString("N2")</small>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="d-block text-muted">Customer</small>
                                            <span class="fw-medium">@item.Order.User?.FullName</span>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge bg-danger rounded-pill px-3">@item.ActiveReturns.Count Item(s) Requested</span>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <button class="btn btn-danger shadow-sm" data-bs-toggle="modal" data-bs-target="#modal-@item.Order.OrderId">
                                                Review & Process
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="modal fade" id="modal-@item.Order.OrderId" tabindex="-1">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content border-0 rounded-4">
                                        <div class="modal-header bg-danger text-white border-0">
                                            <h5 class="modal-title fw-bold">Return Review: #@item.Order.OrderNumber</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form asp-action="ProcessReturn" method="post">
                                            <div class="modal-body p-4">
                                                <label class="fw-bold mb-2">Requested Items:</label>
                                                @foreach (var ret in item.ActiveReturns)
                                                {
                                                    <input type="hidden" name="returnId" value="@ret.ReturnId" />
                                                    <div class="p-3 bg-light rounded-3 mb-2 border">
                                                        <div class="d-flex justify-content-between">
                                                            <span class="fw-medium">Product ID: @ret.ProductId</span>
                                                            <span class="badge bg-white text-dark border">Qty: @ret.Quantity</span>
                                                        </div>
                                                        <p class="mb-0 mt-2 small text-muted font-italic">
                                                            "Reason: @(string.IsNullOrEmpty(ret.Reason) ? "Not Specified" : ret.Reason)"
                                                        </p>
                                                    </div>
                                                }
                                                <div class="mt-3">
                                                    <label class="fw-bold small mb-1">Admin Comment (Reason for Decision)</label>
                                                    <textarea name="adminComment" class="form-control rounded-3" rows="3" required placeholder="Describe why you are approving/rejecting..."></textarea>
                                                </div>
                                            </div>
                                            <div class="modal-footer border-0 p-4 pt-0">
                                                <button type="submit" name="status" value="APPROVED" class="btn btn-success flex-grow-1 py-2 fw-bold rounded-3">
                                                    <i class="fas fa-check me-2"></i>Approve Return
                                                </button>
                                                <button type="submit" name="status" value="REJECTED" class="btn btn-outline-danger flex-grow-1 py-2 fw-bold rounded-3">
                                                    Reject
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    .nav-pills .nav-link {
        color: #6c757d;
        border-radius: 10px;
        transition: 0.3s;
    }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 4px 12px rgba(13,110,253,0.3);
        }

        .nav-pills .nav-link:hover:not(.active) {
            background-color: #f8f9fa;
            color: #0d6efd;
        }

    .bg-soft-success {
        background-color: rgba(25,135,84,0.1);
    }
</style>
